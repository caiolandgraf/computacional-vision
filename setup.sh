#!/bin/bash

# ============================================================================
# Setup Script para Sistema de Detec√ß√£o de Mato Alto
# ============================================================================
# Descri√ß√£o: Script automatizado de instala√ß√£o com verifica√ß√£o de depend√™ncias,
#            tratamento de erros avan√ßado e suporte multiplataforma
# Vers√£o: 2.0
# Compatibilidade: macOS, Linux, WSL
# ============================================================================

set -e  # Parar execu√ß√£o em caso de erro

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configura√ß√µes
PYTHON_MIN_VERSION="3.8"
RECOMMENDED_PYTHON="3.11"
PROJECT_NAME="Sistema de Detec√ß√£o de Mato Alto"
VENV_NAME="venv"
REQUIREMENTS_FILE="requirements.txt"

# ============================================================================
# FUN√á√ïES UTILIT√ÅRIAS
# ============================================================================

print_header() {
    echo -e "${CYAN}"
    echo "============================================================================"
    echo "üåø $PROJECT_NAME - Setup Automatizado v2.0"
    echo "============================================================================"
    echo -e "${NC}"
}

print_step() {
    echo -e "${BLUE}[ETAPA]${NC} $1"
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

print_info() {
    echo -e "${PURPLE}‚ÑπÔ∏è  $1${NC}"
}

# Fun√ß√£o para verificar vers√£o do Python
check_python_version() {
    local python_cmd=$1
    if command -v "$python_cmd" &> /dev/null; then
        local version=$($python_cmd --version 2>&1 | sed 's/Python //')
        local major=$(echo $version | cut -d. -f1)
        local minor=$(echo $version | cut -d. -f2)
        local min_major=$(echo $PYTHON_MIN_VERSION | cut -d. -f1)
        local min_minor=$(echo $PYTHON_MIN_VERSION | cut -d. -f2)

        if [ "$major" -gt "$min_major" ] || ([ "$major" -eq "$min_major" ] && [ "$minor" -ge "$min_minor" ]); then
            echo "$version"
            return 0
        fi
    fi
    return 1
}

# Detectar sistema operacional
detect_os() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macOS"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if grep -q Microsoft /proc/version 2>/dev/null; then
            echo "WSL"
        else
            echo "Linux"
        fi
    elif [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]]; then
        echo "Windows"
    else
        echo "Unknown"
    fi
}

# Verificar se comando existe
command_exists() {
    command -v "$1" &> /dev/null
}

# Instalar depend√™ncias do sistema
install_system_dependencies() {
    local os_type=$(detect_os)
    print_step "Verificando depend√™ncias do sistema para $os_type"

    case $os_type in
        "macOS")
            if ! command_exists brew; then
                print_warning "Homebrew n√£o encontrado. Recomenda-se instalar:"
                echo "  /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
                echo ""
                read -p "Continuar sem Homebrew? (y/n): " -n 1 -r
                echo
                if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                    exit 1
                fi
            else
                print_info "Homebrew detectado. Verificando depend√™ncias..."
                # Instalar depend√™ncias se necess√°rio
                if ! brew list python@3.11 &>/dev/null && ! brew list python@3.10 &>/dev/null; then
                    print_info "Instalando Python via Homebrew..."
                    brew install python@3.11 || print_warning "Falha ao instalar Python via Homebrew"
                fi
            fi
            ;;
        "Linux"|"WSL")
            print_info "Verificando depend√™ncias do sistema Linux..."
            if command_exists apt-get; then
                # Ubuntu/Debian
                sudo apt-get update -qq
                sudo apt-get install -y python3 python3-pip python3-venv python3-dev
                sudo apt-get install -y libgl1-mesa-glx libglib2.0-0 libsm6 libxext6 libxrender-dev
            elif command_exists yum; then
                # RHEL/CentOS/Fedora
                sudo yum install -y python3 python3-pip python3-venv python3-devel
                sudo yum install -y mesa-libGL glib2 libSM libXext libXrender
            elif command_exists pacman; then
                # Arch Linux
                sudo pacman -S --noconfirm python python-pip
            else
                print_warning "Gerenciador de pacotes n√£o reconhecido. Instale manualmente:"
                echo "  - Python 3.8+ com pip e venv"
                echo "  - Bibliotecas OpenCV (libgl1-mesa-glx, libglib2.0-0)"
            fi
            ;;
        *)
            print_warning "Sistema operacional n√£o reconhecido. Prosseguindo com instala√ß√£o b√°sica..."
            ;;
    esac
}

# Encontrar melhor comando Python
find_python_command() {
    local python_commands=("python3.13" "python3.12" "python3.11" "python3.10" "python3.9" "python3.8" "python3" "python")

    for cmd in "${python_commands[@]}"; do
        if version=$(check_python_version "$cmd"); then
            echo "$cmd"
            return 0
        fi
    done

    return 1
}

# ============================================================================
# MAIN SETUP PROCESS
# ============================================================================

main() {
    print_header

    # Verificar se estamos no diret√≥rio correto
    if [[ ! -f "$REQUIREMENTS_FILE" ]]; then
        print_error "Arquivo requirements.txt n√£o encontrado!"
        print_info "Execute este script no diret√≥rio raiz do projeto."
        exit 1
    fi

    print_step "Detectando ambiente..."
    local os_type=$(detect_os)
    print_success "Sistema detectado: $os_type"

    # Instalar depend√™ncias do sistema se necess√°rio
    install_system_dependencies

    # Encontrar comando Python adequado
    print_step "Verificando instala√ß√£o do Python..."

    if python_cmd=$(find_python_command); then
        local version=$(check_python_version "$python_cmd")
        print_success "Python encontrado: $python_cmd (vers√£o $version)"

        if [[ "$version" == "$RECOMMENDED_PYTHON"* ]]; then
            print_success "Vers√£o recomendada em uso!"
        elif [[ "$version" < "$PYTHON_MIN_VERSION" ]]; then
            print_warning "Vers√£o abaixo da recomendada. Funcionalidade pode ser limitada."
        fi
    else
        print_error "Python $PYTHON_MIN_VERSION ou superior n√£o encontrado!"
        echo ""
        print_info "Instala√ß√£o recomendada por sistema:"
        echo ""
        echo "macOS:"
        echo "  brew install python@3.11"
        echo ""
        echo "Ubuntu/Debian:"
        echo "  sudo apt update && sudo apt install python3.11 python3.11-venv python3.11-dev"
        echo ""
        echo "Windows:"
        echo "  Baixe de: https://www.python.org/downloads/"
        echo ""
        exit 1
    fi

    # Criar ambiente virtual
    print_step "Configurando ambiente virtual..."

    if [[ -d "$VENV_NAME" ]]; then
        print_info "Ambiente virtual existente encontrado."
        read -p "Recriar ambiente virtual? (recomendado) (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            rm -rf "$VENV_NAME"
            print_info "Ambiente virtual anterior removido."
        fi
    fi

    if [[ ! -d "$VENV_NAME" ]]; then
        print_info "Criando novo ambiente virtual..."
        if $python_cmd -m venv "$VENV_NAME"; then
            print_success "Ambiente virtual criado com sucesso!"
        else
            print_error "Falha ao criar ambiente virtual!"
            print_info "Tente: $python_cmd -m pip install --user --upgrade pip setuptools"
            exit 1
        fi
    fi

    # Ativar ambiente virtual
    print_step "Ativando ambiente virtual..."
    source "$VENV_NAME/bin/activate"
    print_success "Ambiente virtual ativado!"

    # Atualizar pip
    print_step "Atualizando pip..."
    if pip install --upgrade pip setuptools wheel; then
        local pip_version=$(pip --version | cut -d' ' -f2)
        print_success "pip atualizado para vers√£o $pip_version"
    else
        print_warning "Falha ao atualizar pip, prosseguindo..."
    fi

    # Instalar depend√™ncias
    print_step "Instalando depend√™ncias Python..."
    print_info "Isso pode levar alguns minutos na primeira execu√ß√£o..."

    # Instalar depend√™ncias com retry em caso de falha
    local max_retries=3
    local retry_count=0

    while [ $retry_count -lt $max_retries ]; do
        if pip install -r "$REQUIREMENTS_FILE"; then
            print_success "Todas as depend√™ncias instaladas com sucesso!"
            break
        else
            retry_count=$((retry_count + 1))
            if [ $retry_count -lt $max_retries ]; then
                print_warning "Tentativa $retry_count falhou. Tentando novamente em 5 segundos..."
                sleep 5
            else
                print_error "Falha ao instalar depend√™ncias ap√≥s $max_retries tentativas!"
                echo ""
                print_info "Solu√ß√µes poss√≠veis:"
                echo "  1. Verificar conex√£o com internet"
                echo "  2. Instalar manualmente: pip install -r requirements.txt"
                echo "  3. Usar vers√µes mais recentes: pip install --upgrade -r requirements.txt"
                exit 1
            fi
        fi
    done

    # Verificar instala√ß√£o das depend√™ncias principais
    print_step "Verificando instala√ß√£o das depend√™ncias principais..."

    local dependencies=("cv2:opencv-python" "numpy:numpy" "sklearn:scikit-learn" "scipy:scipy")
    local failed_deps=()

    for dep in "${dependencies[@]}"; do
        local module_name="${dep%:*}"
        local package_name="${dep#*:}"

        if python -c "import $module_name; print('‚úÖ $package_name:', $module_name.__version__ if hasattr($module_name, '__version__') else 'OK')" 2>/dev/null; then
            continue
        else
            print_warning "Problema com $package_name"
            failed_deps+=("$package_name")
        fi
    done

    if [ ${#failed_deps[@]} -gt 0 ]; then
        print_warning "Algumas depend√™ncias podem ter problemas:"
        for dep in "${failed_deps[@]}"; do
            echo "  - $dep"
        done
        echo ""
        print_info "O sistema pode funcionar parcialmente. Execute os testes para verificar."
    else
        print_success "Todas as depend√™ncias principais verificadas!"
    fi

    # Criar diret√≥rios necess√°rios
    print_step "Criando estrutura de diret√≥rios..."
    local dirs=("output" "models" "logs")
    for dir in "${dirs[@]}"; do
        if [[ ! -d "$dir" ]]; then
            mkdir -p "$dir"
            print_success "Diret√≥rio criado: $dir/"
        else
            print_info "Diret√≥rio j√° existe: $dir/"
        fi
    done

    # Executar testes b√°sicos
    print_step "Executando testes b√°sicos..."

    # Teste de importa√ß√£o
    if python -c "
import sys
sys.path.append('src')
try:
    from detector import GrassDetector
    print('‚úÖ M√≥dulo principal importado com sucesso!')
except Exception as e:
    print(f'‚ùå Erro ao importar m√≥dulo principal: {e}')
    sys.exit(1)
"; then
        print_success "Teste de importa√ß√£o passou!"
    else
        print_error "Teste de importa√ß√£o falhou!"
        echo ""
        print_info "Isso pode indicar problemas com as depend√™ncias."
        print_info "Execute manualmente: python -c 'from src.detector import GrassDetector'"
    fi

    # Teste com imagem de exemplo (se dispon√≠vel)
    if [[ -f "examples/exemplo_mato_alto.jpg" ]]; then
        print_info "Executando teste com imagem de exemplo..."
        if timeout 30 python src/main.py --image examples/exemplo_mato_alto.jpg --method color &>/dev/null; then
            print_success "Teste com imagem de exemplo passou!"
        else
            print_warning "Teste com imagem demorou mais que esperado ou falhou."
            print_info "Isso √© normal na primeira execu√ß√£o. O sistema deve funcionar normalmente."
        fi
    fi

    # Mostrar informa√ß√µes finais
    print_step "Finalizando instala√ß√£o..."
    echo ""
    echo -e "${GREEN}üéâ Instala√ß√£o conclu√≠da com sucesso!${NC}"
    echo ""
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${CYAN}  COMO USAR O SISTEMA${NC}"
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    echo -e "${YELLOW}1. Sempre ative o ambiente virtual primeiro:${NC}"
    echo "   source venv/bin/activate"
    echo ""
    echo -e "${YELLOW}2. Execute o sistema:${NC}"
    echo "   # Menu interativo (recomendado para iniciantes):"
    echo "   python3 src/main.py"
    echo ""
    echo "   # An√°lise direta de imagem:"
    echo "   python3 src/main.py --image caminho/da/imagem.jpg"
    echo ""
    echo "   # An√°lise com m√©todo espec√≠fico:"
    echo "   python3 src/main.py --image caminho/da/imagem.jpg --method combined"
    echo ""
    echo "   # An√°lise em lote:"
    echo "   python3 src/main.py --batch pasta_com_imagens/"
    echo ""
    echo -e "${YELLOW}3. Exemplos e testes:${NC}"
    echo "   python3 examples/demo.py"
    echo "   python3 examples/test_reliability.py"
    echo ""
    echo -e "${YELLOW}4. Ajuda e documenta√ß√£o:${NC}"
    echo "   python3 src/main.py --help"
    echo "   cat README.md"
    echo ""
    echo -e "${PURPLE}üìÅ Resultados s√£o salvos em: output/${NC}"
    echo -e "${PURPLE}üìö Documenta√ß√£o completa: README.md${NC}"
    echo -e "${PURPLE}üêõ Problemas? Veja se√ß√£o 'Solu√ß√£o de Problemas' no README${NC}"
    echo ""

    # Verifica√ß√£o final do ambiente
    local python_location=$(which python)
    local pip_location=$(which pip)

    if [[ "$python_location" == *"$VENV_NAME"* ]] && [[ "$pip_location" == *"$VENV_NAME"* ]]; then
        print_success "Ambiente virtual configurado corretamente!"
    else
        print_warning "Ambiente virtual pode n√£o estar ativo. Execute: source venv/bin/activate"
    fi

    echo ""
    echo -e "${GREEN}üåø O Sistema de Detec√ß√£o de Mato Alto est√° pronto para uso!${NC}"
    echo ""
}

# Tratamento de interrup√ß√£o
trap 'echo -e "\n${RED}‚ùå Instala√ß√£o interrompida pelo usu√°rio${NC}"; exit 1' INT

# Executar fun√ß√£o principal
main "$@"
